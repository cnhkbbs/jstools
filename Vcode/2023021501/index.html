<html>
<head>
<title>main.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s0"># -*- author:cyq-*-</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1"><a href="db.html">db</a></span>
<span class="s2">import </span><span class="s1">requests</span>
<span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">import </span><span class="s1">urllib</span>
<span class="s2">import </span><span class="s1">json</span>


<span class="s0"># 信息输出部分</span>
<span class="s2">def </span><span class="s1">print_INFO(message):</span>
    <span class="s1">print(</span><span class="s3">'[' </span><span class="s1">+ datetime.datetime.now().strftime(</span><span class="s3">'%H:%M:%S'</span><span class="s1">) + </span><span class="s3">']' </span><span class="s1">+ message)</span>


<span class="s2">def </span><span class="s1">print_ERROR(error):</span>
    <span class="s1">print(</span><span class="s3">'[' </span><span class="s1">+ datetime.datetime.now().strftime(</span><span class="s3">'%H:%M:%S'</span><span class="s1">) + </span><span class="s3">']' </span><span class="s1">+ </span><span class="s3">&quot;</span><span class="s2">\033</span><span class="s3">[1;31m&quot; </span><span class="s1">+ error + </span><span class="s3">&quot; </span><span class="s2">\033</span><span class="s3">[0m&quot;</span><span class="s1">)</span>

<span class="s0"># 登录部分</span>
<span class="s2">def </span><span class="s1">login(name</span><span class="s2">, </span><span class="s1">pwd</span><span class="s2">, </span><span class="s1">dbcol):</span>
    <span class="s0"># 本地写入</span>
    <span class="s1">user_config = </span><span class="s3">'{&quot;name&quot;:' </span><span class="s1">+ </span><span class="s3">'&quot;' </span><span class="s1">+ name + </span><span class="s3">'&quot;' </span><span class="s1">+ </span><span class="s3">',&quot;password&quot;:' </span><span class="s1">+ </span><span class="s3">'&quot;' </span><span class="s1">+ pwd + </span><span class="s3">'&quot;' </span><span class="s1">+ </span><span class="s3">'}'</span>
    <span class="s2">with </span><span class="s1">open(</span><span class="s3">&quot;user.json&quot;</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">jsonwrite:</span>
        <span class="s1">jsonwrite.write(user_config)</span>
    <span class="s0"># 云端上传</span>
    <span class="s1">db_data = {</span><span class="s3">'_id'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'name'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'password'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s1">}</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">dbcol.find({</span><span class="s3">'name'</span><span class="s1">: name}):</span>
        <span class="s1">db_data = i</span>
    <span class="s2">if </span><span class="s1">name == db_data[</span><span class="s3">'name'</span><span class="s1">]:</span>
        <span class="s2">if </span><span class="s1">pwd == db_data[</span><span class="s3">'password'</span><span class="s1">]:</span>
            <span class="s1">print_INFO(</span><span class="s3">&quot;登录成功!&quot;</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">os.remove(</span><span class="s3">'user.json'</span><span class="s1">)</span>
            <span class="s1">print_INFO(</span><span class="s3">&quot;您的密码错误或用户已被注册&quot;</span><span class="s1">)</span>
            <span class="s2">return </span><span class="s4">0</span>
    <span class="s2">elif </span><span class="s1">db_data[</span><span class="s3">'name'</span><span class="s1">] == </span><span class="s3">'None'</span><span class="s1">:</span>
        <span class="s1">dbcol.insert_one({</span><span class="s3">'name'</span><span class="s1">: name</span><span class="s2">, </span><span class="s3">'password'</span><span class="s1">: pwd</span><span class="s2">, </span><span class="s3">'balance'</span><span class="s1">: </span><span class="s4">50</span><span class="s1">})</span>
        <span class="s1">print_INFO(</span><span class="s3">'注册成功'</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s4">50</span>
    <span class="s2">return </span><span class="s1">db_data[</span><span class="s3">'balance'</span><span class="s1">]</span>

<span class="s0"># 结果同步部分</span>
<span class="s2">def </span><span class="s1">up_load(problem_col</span><span class="s2">, </span><span class="s1">title</span><span class="s2">, </span><span class="s1">balance</span><span class="s2">, </span><span class="s1">anser=</span><span class="s2">None, </span><span class="s1">anser0=</span><span class="s2">None, </span><span class="s1">anser1=</span><span class="s2">None, </span><span class="s1">anser2=</span><span class="s2">None,</span><span class="s1">):</span>
    <span class="s1">db_data = {</span><span class="s3">'title'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'anser'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'anser0'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'anser1'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'anser2'</span><span class="s1">: </span><span class="s3">'None'</span><span class="s1">}</span>
    <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">problem_col.find({</span><span class="s3">'title'</span><span class="s1">:title}):</span>
        <span class="s1">db_data = j</span>
    <span class="s2">if </span><span class="s1">title == db_data[</span><span class="s3">'title'</span><span class="s1">]:</span>
        <span class="s1">problem_col.insert_one({</span><span class="s3">'title'</span><span class="s1">: </span><span class="s3">'title'</span><span class="s2">, </span><span class="s3">'anser'</span><span class="s1">: </span><span class="s3">'123456'</span><span class="s2">, </span><span class="s3">'anser0'</span><span class="s1">: </span><span class="s3">'123456'</span><span class="s2">, </span><span class="s3">'anser1'</span><span class="s1">: </span><span class="s3">'123456'</span><span class="s2">, </span><span class="s3">'anser2'</span><span class="s1">: </span><span class="s3">'123456'</span><span class="s1">})</span>

<span class="s2">def </span><span class="s1">get_anser_API1(title):  </span><span class="s0"># 模糊查询</span>
    <span class="s1">headers = {</span><span class="s3">'Content-type'</span><span class="s1">: </span><span class="s3">'application/x-www-form-urlencoded'</span><span class="s1">}</span>
    <span class="s1">url = </span><span class="s3">'http://cx.icodef.com/wyn-nb?v=4'</span>
    <span class="s1">data = </span><span class="s3">'question=' </span><span class="s1">+ urllib.parse.quote(title)</span>
    <span class="s1">back_json = requests.post(url</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">headers=headers).text</span>
    <span class="s1">back_dict = json.loads(back_json)</span>
    <span class="s2">if </span><span class="s1">back_dict[</span><span class="s3">&quot;code&quot;</span><span class="s1">] == -</span><span class="s4">1</span><span class="s1">:</span>
        <span class="s1">print_INFO(</span><span class="s3">'接口1号未找到答案'</span><span class="s1">)</span>
        <span class="s2">return None</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">anser = back_dict[</span><span class="s3">&quot;data&quot;</span><span class="s1">]</span>
        <span class="s1">print_INFO(</span><span class="s3">&quot;接口1查询结果： &quot; </span><span class="s1">+ back_dict[</span><span class="s3">&quot;data&quot;</span><span class="s1">])</span>
        <span class="s2">return </span><span class="s1">anser</span>


<span class="s2">def </span><span class="s1">get_anser_API2(title):  </span><span class="s0"># 精确查询</span>
    <span class="s1">headers = {</span><span class="s3">'Content-type'</span><span class="s1">: </span><span class="s3">'application/x-www-form-urlencoded'</span><span class="s1">}</span>
    <span class="s1">url = </span><span class="s3">'http://api.muketool.com/v1/cx'</span>
    <span class="s1">data = </span><span class="s3">'question=' </span><span class="s1">+ urllib.parse.quote(title)</span>
    <span class="s1">back_json = requests.post(url</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">headers=headers).text</span>
    <span class="s1">back_dict = json.loads(back_json)</span>
    <span class="s2">if </span><span class="s1">back_dict[</span><span class="s3">&quot;code&quot;</span><span class="s1">] == -</span><span class="s4">1</span><span class="s1">:</span>
        <span class="s1">print_INFO(</span><span class="s3">&quot;接口2号未找到答案&quot;</span><span class="s1">)</span>
        <span class="s2">return None</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">anser = back_dict[</span><span class="s3">&quot;data&quot;</span><span class="s1">]</span>
        <span class="s1">print_INFO(</span><span class="s3">&quot;接口2查询结果： &quot; </span><span class="s1">+ anser)</span>
        <span class="s2">return </span><span class="s1">anser</span>


<span class="s2">def </span><span class="s1">get_anser_API3(title</span><span class="s2">, </span><span class="s1">problem_type):  </span><span class="s0"># 模糊查询</span>
    <span class="s1">headers = {</span>
        <span class="s3">&quot;User-Agent&quot;</span><span class="s1">: </span><span class="s3">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.99 Safari/537.36&quot;</span><span class="s1">}</span>
    <span class="s1">url = </span><span class="s3">'http://14.29.190.187:54223/chaoXing/v3/getAnswer.php?tm=' </span><span class="s1">+ title + </span><span class="s3">'&amp;type=' </span><span class="s1">+ problem_type</span>
    <span class="s1">back_json = requests.get(url</span><span class="s2">, </span><span class="s1">headers=headers).text</span>
    <span class="s1">back_dict = json.loads(back_json)</span>
    <span class="s2">if </span><span class="s1">back_dict[</span><span class="s3">&quot;code&quot;</span><span class="s1">] == </span><span class="s4">1</span><span class="s1">:</span>
        <span class="s1">anser = back_dict[</span><span class="s3">&quot;data&quot;</span><span class="s1">]</span>
        <span class="s1">print_INFO(</span><span class="s3">&quot;接口3查询结果： &quot; </span><span class="s1">+ anser)</span>
        <span class="s2">return </span><span class="s1">anser</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">print_INFO(</span><span class="s3">&quot;接口3未找到答案&quot;</span><span class="s1">)</span>
        <span class="s2">return None</span>


<span class="s2">if </span><span class="s1">__name__ == </span><span class="s3">&quot;__main__&quot;</span><span class="s1">:</span>
    <span class="s0"># 获取Mongo数据库集合</span>
    <span class="s1">print_INFO(</span><span class="s3">&quot;尝试与数据库建立连接..........&quot;</span><span class="s1">)</span>
    <span class="s1">client = db.db_connect()</span>
    <span class="s1">db = client.problemsDB</span>
    <span class="s1">problem_col = db.problem_0</span>
    <span class="s1">user_col = db.userDB</span>
    <span class="s0"># 特殊模式开关</span>
    <span class="s1">tw_mode = </span><span class="s2">False</span>
    <span class="s1">api3_mode = </span><span class="s2">False</span>
    <span class="s2">if </span><span class="s1">client:</span>
        <span class="s0"># 载入部分</span>
        <span class="s1">print(</span><span class="s3">'------------DTduck------------'</span><span class="s1">)</span>
        <span class="s1">print(</span><span class="s3">'使用提示: 请将完整题目键入下方空白处，按回车键查询'</span><span class="s1">)</span>
        <span class="s1">print(</span><span class="s3">'特殊指指令 0：退出程序   tw：投喂模式'</span><span class="s1">)</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">with </span><span class="s1">open(</span><span class="s3">&quot;user.json&quot;</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">jsondata:</span>
                <span class="s1">userjson = json.load(jsondata)</span>
            <span class="s1">user_Name = userjson[</span><span class="s3">&quot;name&quot;</span><span class="s1">]</span>
            <span class="s1">user_Pwd = userjson[</span><span class="s3">&quot;password&quot;</span><span class="s1">]</span>
            <span class="s1">user_Balance = login(user_Name</span><span class="s2">, </span><span class="s1">user_Pwd</span><span class="s2">, </span><span class="s1">user_col)</span>
        <span class="s2">except </span><span class="s1">Exception:</span>
            <span class="s1">print(</span><span class="s3">&quot;你似乎是第一次使用，请注册或登录&quot;</span><span class="s1">)</span>
            <span class="s1">name = input(</span><span class="s3">&quot;用户名：&quot;</span><span class="s1">)</span>
            <span class="s1">pwd = input(</span><span class="s3">&quot;密码：&quot;</span><span class="s1">)</span>
            <span class="s1">user_Balance = login(name</span><span class="s2">, </span><span class="s1">pwd</span><span class="s2">, </span><span class="s1">user_col)</span>
        <span class="s1">print_INFO(</span><span class="s3">'剩余次数：'</span><span class="s1">+user_Balance+</span><span class="s3">&quot;(可以通过投喂模式增加)&quot;</span><span class="s1">)</span>
        <span class="s0"># 交互部分</span>
        <span class="s2">while </span><span class="s4">1</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">user_Balance &lt; </span><span class="s4">1 </span><span class="s1">:</span>
                <span class="s1">print_ERROR(</span><span class="s3">'可用查询次数不足，请通过投喂模式增加'</span><span class="s1">)</span>
                <span class="s2">break</span>
            <span class="s1">print(</span><span class="s3">&quot;----------------------------------------&quot;</span><span class="s1">)</span>
            <span class="s1">problem_title = input(</span><span class="s3">'题目：'</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">problem_title == </span><span class="s3">'0'</span><span class="s1">:</span>
                <span class="s2">break</span>
            <span class="s2">elif </span><span class="s1">problem_title == </span><span class="s3">'tw'</span><span class="s1">:</span>
                <span class="s1">tw_mode = </span><span class="s2">True</span>
                <span class="s1">print_INFO(</span><span class="s3">'投喂模式开启'</span><span class="s1">)</span>
            <span class="s2">elif </span><span class="s1">problem_title == </span><span class="s3">'3'</span><span class="s1">:</span>
                <span class="s1">api3_mode = </span><span class="s2">True</span>
                <span class="s1">print_INFO(</span><span class="s3">'API3已开启'</span><span class="s1">)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">anser_1 = get_anser_API1(problem_title)</span>
                <span class="s1">anser_2 = get_anser_API2(problem_title)</span>
                <span class="s2">if </span><span class="s1">api3_mode:</span>
                    <span class="s1">problem_type = input(</span><span class="s3">'题目类型,0 判断  1 单选 3 多选'</span><span class="s1">)</span>
                    <span class="s1">anser_3 = get_anser_API3(problem_title</span><span class="s2">, </span><span class="s1">problem_type)</span>
            <span class="s0"># get_anser_API2(problem_title)</span>
            <span class="s1">input()</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">print_ERROR(</span><span class="s3">&quot;与数据库建立连接失败，请重试！&quot;</span><span class="s1">)</span>
    <span class="s1">input(</span><span class="s3">&quot;按任意键退出程序&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>